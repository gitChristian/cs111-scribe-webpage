<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>CS 111 Lecture 14</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.scrollzer.min.js"></script>
		<script src="js/jquery.scrolly.min.js"></script>
		<script src="js/skel.min.js"></script>
		<script src="js/skel-layers.min.js"></script>
		<script src="js/init.js"></script>
		<noscript>
			<link rel="stylesheet" href="css/skel.css" />
			<link rel="stylesheet" href="css/style.css" />
			<link rel="stylesheet" href="css/style-xlarge.css" />
		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>
	<body>
		<div id="wrapper">

			<!-- Header -->
			<!-- We don' really need this
				<section id="header" class="skel-layers-fixed">
					<header>
						<span class="image avatar"><img src="images/avatar.jpg" alt="" /></span>
						<h1 id="logo"><a href="#">Willis Corto</a></h1>
						<p>I got reprogrammed by a rogue AI<br />
						and now I'm totally cray</p>
					</header>
					<nav id="nav">
						<ul>
							<li><a href="#one" class="active">About</a></li>
							<li><a href="#two">Things I Can Do</a></li>
							<li><a href="#three">A Few Accomplishments</a></li>
						</ul>
					</nav>
					
				</section>

			-->

			

					<!-- Heading-->
						<section id="one">
							<div class="container">
								<header class="major">
									<h2>File System Robustness: <br>CS111 Lecture 14</h2>
									<h4>By Christian Nersesyan, David Antonio Garcia, Victoria Bernard</h4>
								</header>
							</div>
						</section>
					<!-- Overview Navigation -->
							<section id="overview">
							<div class="container">
						<!--	<div class="features"> -->
							  <article>
								<h2>Overview</h2>
										<ol id="toc">
											<li><a href="#robustness_intro">Robustness in File Systems</a></li>
											<ol>
													<li><a href="#terms">Theory and Terminology</a></li>	
													<li><a href="#invarients">Invariants for a  FS</a></li>		
														
												</ol>
											<li><a href="#problems">Performance Issues</a>
												<ol>
													<li><a href="#problem1">Cache Coherence</a></li>
													<!--	<ol><li> <a href="#problem1_sol">Potential Solution</a></li></ol> -->
													<li><a href="#problem2">Renaming</a></li>													
												</ol>
											</li>
											<li><a href="#schedule_robust">Interaction between Scheduling and Robustness</a>
											<li><a href="#references">References</a></li>
										</ol>
								</div>
						</section>
						</article>
						<!-- Antonio your work here -->
						<div class="container">
						<h3><a name="#terms"></a>Theory and Terminology</h3>
						<dt>Antonio</dt>
						<dt>Antonio</dt>
						<dt>Antonio</dt>
						<dt>Antonio</dt>
						<dt>Antonio</dt>
						<dt>Antonio</dt>
						<dd></dd><dd></dd><dd></dd>
					<!-- Two -->
						<section id="two">
							<div class="container">
								<h3><a name="robustness_intro"></a>Robustness in File Systems</h3>
								<h4>Berkley Fast File System (BSD)</h4>
								<a href="#" class="image"><img src="images/BSD_diagram.jpg" alt="" /></a>
								<h3>Ways to evaluate a file system</h3>

								<p>Say you are the product manager of an operating system. How do you go about choosing a file system for your OS?
								How can you make sure the FS you choose is robust? We can test invariants. Invariants in this case are boolean expresssions
								that should always be true for the FS.</p>
								
								
								<a name="#invarients"></a><h4>Invariants for a  FS</h4>
								<dl>
									<dt> 1. Each block in FS in used for only one purpose </dt>
									<dd>&emsp;&emsp; Ex. of purposes: superblock, free bitmap, inodes, etc. </dd>
									
									<dt>2. All reference blocks are initialized to data that are appropriate to that block.</dt>
									<dd>&emsp;&emsp; Never leave data in an invalid state. For example, don't initialize an inode with a negative file size.</dd>
									
									<dt>3. All reference data blocks are marked used in the bitmap.</dt>
									<dd></dd>
									
									<dt>4. All unreferenced data blocks are marked free in bitmap.</dt>
									<dd></dd>
								</dl>
								<p>Let's refer to the above invariants as the rules of our FS.</p>
								
								<h4>Consequences of breaking these rules</h4>
								<dl>
									<dt>1. Disaster </dt><dd></dd>
									<dt>2. Disaster</dt><dd></dd>
									<dt>2. Disaster</dt><dd></dd>
									<dt>4. We loose space in our FS (unused leak). <!-- Victoria added this line -->We are permanently marking a block as unuseable, so we are wasting memory space. </dt><dd></dd>
								</dl>
								<p>Rules 1-3 tend to have the highest prioty from developers since breaking these rules will corrupt the entire FS. 
								Rule 4, although important, has less devastating effects.</p>
								
								
								
							</div>
						</section>
						
					<!-- Victoria -->
						<section >
							<div class="container">
								<a name="problems"></a><h3>Performance Issues</h3>
								<p><a href="#" class="image"><img src="images/Dally_diagram.jpg" alt="" /></a></p>
								
								<a name="problem1"></a><h4>Problem 1 : Cache Coherence </h4>
								<dl><!--- It would be cool if I could change the font below-->
									<dt><h5> <i>Definition:</i> cache unintentionally differs from memory </h5></dt><dd></dd>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;&emsp; write(fd, "hello", s );  </dt><dd></dd>
									<dt> &emsp;&emsp;&emsp; read (fd, buffer, s ); </dt><dd></dd></div>
									<dt> Most OS use a process called <i> dallying - </i>  certain tasks are prioritized over prior tasks</dt>
									<dt> Suppose fd is a regular file on the disk. What if  kernel locks at cache? then data would never be copied back to disk</dt><dd></dd>							
									<dt> Why do we care so much? </dt><dd></dd>
									<dd>&emsp;&emsp; - cache may differ from disk causes invalid reads </dt><dd></dd>
									<dd>&emsp;&emsp; - write success notified to user was successful when maybe it wasn't. </dt><dd></dd>
									<dd>&emsp;&emsp; - some side effects may not be saved due to out of order writes </dd>
									<dd>&emsp;&emsp; -  </dd>
									<dt> Sources of this problem</dt><dd></dd>
									<dt> -  Power Loss </dt>
									<dt> -  Disk crash </dt>
									<dt> -  Suddend Disconnection </dt>
									
								</dl>
								<h5> Potential Solutions </h5>
								<dl>
									<dt>1. Maintain a backup power supply in case of power loss to ensure cache always gets copied to disk.  </dt><dd></dd>
									<dt>2. Syncing functions </dt><dd></dd>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;&emsp; close(int fd) </div></dt>
									<dt>&emsp;&emsp;&emsp; closes the file referred to be fd so that fd will no longer be valid reference to that file</dt>
									<dt>&emsp;&emsp;&emsp; <i> Note: does not "flush" data buffers so it is not guarenteed that prior writes to fd</dt> 
									<dt>&emsp;&emsp;&emsp; were sucessful</dt>		</i>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;&emsp; fsync(int fd) </div></dt>
									<dt>&emsp;&emsp;&emsp; "flushes" data by ensuring any cached data for the file specified by fd is copied to the disk device</dt>
									<dt>&emsp;&emsp;&emsp; (or other permanent storage device); will do so for entire inode and data block</dt>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;&emsp; fdatasync(int fd) </div></dt>
									<dt>&emsp;&emsp;&emsp; same as fsync but improves performance by not copying metadata, unless that metadata is </dt> 
									<dt>&emsp;&emsp;&emsp; needed in order to allow a subsequent data retrieval to be correctly handled</dt>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;&emsp; sync(void) </div></dt>
									<dt>&emsp;&emsp;&emsp; same as fsync but does so for every file in the cache; everything is written before sync call is</dt>
									<dt>&emsp;&emsp;&emsp;saved</dt>
									<dd></dd>						
									<h5> Example </h5>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;if(fsync(fd) != 0) error(); </dt><dd></dd> 
									<dt> &emsp;&emsp;if(write(fd , buf, 8192) != 8192)error(); </dt><dd></dd> 
									<dt> &emsp;&emsp;if(fsync(fd) != 0) error(); </dt><dd></dd> </div><dd></dd>
									<dt> Above code has to change all 20 data blocks and the inode data, slowing performance significantly </dt><dd></dd>
									<dd></dd>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;if(fsync(fd) != 0) error(); </dt><dd></dd> 
									<dt> &emsp;&emsp;if(write(fd , buf, 8192) != 8192)error(); </dt><dd></dd> 
									<dt> &emsp;&emsp;if(fdatasync(fd) != 0) error(); </dt><dd></dd> </div><dd></dd>
									<dt> Now only the 8192/1024<i>(block size)</i> = 8 blocks have to be copied over</dt><dd></dd>
								</dl>
									
							<a name="problem2"></a><h4>Problem 2 : Renaming </h4>
								<dl><!--- It would be cool if I could change the font below-->
									<dt><h5>  Consider the following situation</h5></dt><dd></dd>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp;&emsp;&emsp; rename("a","b");  </dt><dd></dd></div><dd></dd><dd></dd>
									<a href="#" class="image"><img src="images/Rename_diagram.jpg" alt="" /></a>
									<dt> &emsp;&emsp;&emsp; if rename fails and system crashes we cannot assume the file was not renames.</dt><dd></dd><dd></dd>
									<dt><h5>Another situation</h5></dt><dd></dd>
									<div style="font-family: Consolas; font-size: medium; ">
									<dt> &emsp; rename("x/a","y/b");  </dt><dd></dd></div><dd></dd><dd></dd>
									
									<dt>&emsp; Must follow steps: <i> </dt>
									<dt> &emsp;&emsp; i. read inode</dt>
									<dt> &emsp;&emsp; ii. read x's data</dt>
									<dt> &emsp;&emsp; iii. read y's data</dt>
									<dt> &emsp;&emsp; iv. write y's inode(<i>linkcount = 2</i>)</dt>
									<dt> &emsp;&emsp; v. write x's new data</dt>
									<dt> &emsp;&emsp; vi. change link count back to 1</dt></i>
									<a href="#" class="image"><img src="images/Rename2_diagram.jpg" alt="" /></a>
									<dt> &emsp; Does not preserve all invarients of file systems still because link count temporoary wrong</dt>
									<dt> &emsp; However, this is acceptable because only consequence is if "b" gets deleted later link count will </dt>
									<dt> &emsp; forever remain = 1 and forever unused. </dt>
															
															
								</dl>
								<h5> Potential Solutions </h5>
								<dl>
									<dt><div style="font-family: Consolas; font-size: medium; ">fsck </dt><div>
									<dt>&emsp; program that will perform repairs on storage leaks; goes through and checkes inodes are in use and  
									<dt>&emsp; link count is correct and updates bitmap <i>Note: if system crashes we shall assume fsck is idempotent. </i></dt>
								</dl>
							</div>
						</section>
						
					<!-- Schedule and Robust -->
						<div class="container">
						<h3><a name="#schedule_robust"></a>Interaction between Scheduling and Robustness</h3>
						<!--TODO: Please add here!-->
						<dt>Add me</dt>
						<dt>Add me</dt>
						<dt>Add me</dt>
						<dt>Add me</dt>
						<dt>Add me</dt>
						<dt>Add me</dt>
						<dt>Add me</dt>
				
						<dd></dd><dd></dd><dd></dd>
					
					<!-- References-->
						<section >
							<div class="container">
								<a name="references"></a><h3>References</h3>
								<p>Fall 2014 Ryosuke Takeuchi scribe notes</p>
								<p>http://linux.die.net/man/2/fsync</p>
								
							</div>
						</section>

					<!-- Three -->
						<section id="three">
							<div class="container">
								<h3>A Few Accomplishments</h3>
								<p>Integer eu ante ornare amet commetus vestibulum blandit integer in curae ac faucibus integer non. Adipiscing cubilia elementum integer. Integer eu ante ornare amet commetus.</p>
								<div class="features">
									<article>
										<a href="#" class="image"><img src="images/pic01.jpg" alt="" /></a>
										<div class="inner">
											<h4>Possibly broke spacetime</h4>
											<p>Integer eu ante ornare amet commetus vestibulum blandit integer in curae ac faucibus integer adipiscing ornare amet.</p>
										</div>
									</article>
									<article>
										<a href="#" class="image"><img src="images/pic02.jpg" alt="" /></a>
										<div class="inner">
											<h4>Terraformed a small moon</h4>
											<p>Integer eu ante ornare amet commetus vestibulum blandit integer in curae ac faucibus integer adipiscing ornare amet.</p>
										</div>
									</article>
									<article>
										<a href="#" class="image"><img src="images/pic03.jpg" alt="" /></a>
										<div class="inner">
											<h4>Snapped dark matter in the wild</h4>
											<p>Integer eu ante ornare amet commetus vestibulum blandit integer in curae ac faucibus integer adipiscing ornare amet.</p>
										</div>
									</article>
								</div>
							</div>
						</section>
						
				</div>
				

			<!-- Footer -->
				<section id="footer">
					<div class="container">
						<ul class="copyright">
							<li>GNU General Public License</li>
						</ul>
					</div>
				</section>

		</div>
	</body>
</html>
